{% extends "base.html" %}

{% block title %}Fehler-Detail - Stockmeister{% endblock %}

{% block extra_head %}
<!-- jQuery (must load before chessboard.js) -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<!-- Chess.js for move validation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
<!-- Chessboard.js for board display -->
<link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

<style>
/* Chess.com style board colors */
.white-1e1d7 {
    background-color: #EEEED2 !important;
}

.black-3c85d {
    background-color: #769656 !important;
}

/* Orange highlights */
.highlight-white {
    background-color: rgba(230, 126, 34, 0.5) !important;
}

.highlight-black {
    background-color: rgba(230, 126, 34, 0.6) !important;
}

/* Board coordinates - better visibility */
.notation-322f9 {
    font-weight: bold !important;
    font-size: 11px !important;
}

/* White square coords - dark text */
.white-1e1d7 .notation-322f9 {
    color: #769656 !important;
}

/* Dark square coords - light text */
.black-3c85d .notation-322f9 {
    color: #EEEED2 !important;
}

/* Analysis container with eval bar */
.analysis-container {
    display: flex;
    gap: 0;
    align-items: stretch;
    position: relative;
}

.eval-bar-container {
    width: 30px;
    background: linear-gradient(to bottom, white 50%, #2c3e50 50%);
    position: relative;
    border-radius: 0.5rem 0 0 0.5rem;
    overflow: hidden;
    flex-shrink: 0;
}

.eval-bar {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    background: white;
    transition: height 0.3s ease;
}

.eval-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 11px;
    font-weight: bold;
    z-index: 10;
    color: #2c3e50;
    text-shadow: 0 0 3px white;
}

#board-wrapper {
    flex: 1;
    position: relative;
}

#board {
    border-radius: 0 0.5rem 0.5rem 0;
    overflow: hidden;
}

/* Turn indicator */
.turn-indicator {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 0.5rem;
}

.turn-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid rgba(255, 255, 255, 0.3);
    transition: all 0.2s;
}

.turn-dot.active {
    background: var(--accent);
    border-color: var(--accent);
    box-shadow: 0 0 10px rgba(230, 126, 34, 0.6);
}

/* Move hints */
.move-hint {
    position: absolute;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.15);
    pointer-events: none;
    z-index: 5;
}

.move-hint.capture {
    border: 4px solid rgba(0, 0, 0, 0.15);
    background: transparent;
    border-radius: 50%;
}

/* Arrows - cleaner Chess.com style */
.arrow {
    position: absolute;
    pointer-events: none;
    z-index: 10;
}

/* Navigation controls */
.nav-controls {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    justify-content: center;
    margin-top: 1rem;
    flex-wrap: wrap;
}

.nav-btn {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.9rem;
}

.nav-btn:hover:not(:disabled) {
    background: rgba(230, 126, 34, 0.3);
    border-color: var(--accent);
}

.nav-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
}

.move-number {
    font-family: monospace;
    font-weight: bold;
    color: rgba(255, 255, 255, 0.9);
    padding: 0.5rem 1rem;
}
</style>
{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col">
        <a href="{{ url_for('errors') }}" class="btn btn-sm btn-outline-light">‚Üê Zur√ºck zur √úbersicht</a>
    </div>
</div>

<div class="row">
    <!-- Left: Analysis Board -->
    <div class="col-lg-7 mb-4">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">
                        {% if error.error_type == 'blunder' %}
                            üí• Grober Fehler
                        {% elif error.error_type == 'mistake' %}
                            ‚ö†Ô∏è Fehler
                        {% else %}
                            üìä Ungenauigkeit
                        {% endif %}
                        - Zug {{ error.move_number }}
                    </h5>
                    <div class="turn-indicator">
                        <div class="turn-dot" id="whiteDot"></div>
                        <span id="turnText" style="font-size: 0.9rem;">Wei√ü</span>
                        <div class="turn-dot" id="blackDot"></div>
                    </div>
                </div>

                <div class="analysis-container">
                    <div class="eval-bar-container">
                        <div class="eval-bar" id="evalBar" style="height: 50%;"></div>
                        <div class="eval-text" id="evalText">0.0</div>
                    </div>
                    <div id="board-wrapper">
                        <div id="board" style="width: 100%;"></div>
                    </div>
                </div>

                <!-- Navigation Controls -->
                <div class="nav-controls">
                    <button class="nav-btn" id="btnStart">‚èÆ Start</button>
                    <button class="nav-btn" id="btnPrev">‚óÄ Zur√ºck</button>
                    <span class="move-number" id="moveDisplay">Zug 1</span>
                    <button class="nav-btn" id="btnNext">Vor ‚ñ∂</button>
                    <button class="nav-btn" id="btnEnd">Ende ‚è≠</button>
                </div>

                <div class="text-center mt-3">
                    <small class="text-muted">
                        ‚Üê ‚Üí Pfeiltasten | Rechtsklick = Pfeile zeichnen
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Right: Coach Explanation -->
    <div class="col-lg-5">
        <div class="card" style="background: linear-gradient(135deg, var(--primary) 0%, #34495e 100%);">
            <div class="card-body">
                <div class="d-flex align-items-start gap-3">
                    <div style="flex-shrink: 0;">
                        <img src="{{ url_for('static', filename='images/coach.jpg') }}"
                             alt="Stockmeister"
                             style="width: 60px; height: 60px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.3); object-fit: cover; object-position: center 30%;">
                    </div>
                    <div style="flex: 1;">
                        <div style="background: rgba(255,255,255,0.15); padding: 1.25rem; border-radius: 1rem; position: relative;">
                            <!-- Speech bubble arrow -->
                            <div style="position: absolute; left: -10px; top: 20px; width: 0; height: 0;
                                        border-top: 10px solid transparent;
                                        border-bottom: 10px solid transparent;
                                        border-right: 10px solid rgba(255,255,255,0.15);"></div>

                            <div id="coachExplanation">
                                <!-- Dynamic explanation -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Game data from server
    const allMoves = {{ moves|tojson }};
    const errorMoveNum = {{ error.move_number }};
    const errorPosition = '{{ error.position }}';
    const yourMove = '{{ error.move_played }}';
    const bestMove = '{{ error.best_move }}';
    const errorExplanation = {{ error.explanation|tojson }};
    const errorType = '{{ error.error_type }}';
    const cpLoss = {{ error.centipawn_loss }};
    const evalBefore = {{ error.evaluation_before }};
    const evalAfter = {{ error.evaluation_after }};

    // State
    let currentMoveIndex = 0;
    let board = null;
    let game = new Chess();
    let userArrows = [];

    // Initialize board
    const config = {
        draggable: false,
        position: 'start',
        pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png',
        onMouseoutSquare: onMouseoutSquare,
        onMouseoverSquare: onMouseoverSquare
    };

    board = Chessboard('board', config);

    // Update board to current move
    function updateBoard() {
        game.reset();

        for (let i = 0; i < currentMoveIndex; i++) {
            game.move(allMoves[i].uci);
        }

        board.position(game.fen());
        updateTurnIndicator();
        updateEvaluation();
        updateMoveDisplay();
        updateCoachExplanation();
        clearArrows();

        // Show error arrows at error position
        if (currentMoveIndex === errorMoveNum - 1) {
            setTimeout(() => {
                drawErrorArrows();
            }, 200);
        }
    }

    function updateTurnIndicator() {
        const whiteDot = $('#whiteDot');
        const blackDot = $('#blackDot');
        const turnText = $('#turnText');

        if (game.turn() === 'w') {
            whiteDot.addClass('active');
            blackDot.removeClass('active');
            turnText.text('Wei√ü');
        } else {
            blackDot.addClass('active');
            whiteDot.removeClass('active');
            turnText.text('Schwarz');
        }
    }

    function updateEvaluation() {
        const evalBar = $('#evalBar');
        const evalText = $('#evalText');

        let eval_cp = 0;

        if (currentMoveIndex === errorMoveNum - 1) {
            eval_cp = evalBefore;
        } else if (currentMoveIndex === errorMoveNum) {
            eval_cp = evalAfter;
        } else {
            // Estimate based on material for other positions
            eval_cp = 0;
        }

        // Convert to percentage (white advantage)
        const clamped = Math.max(-1000, Math.min(1000, eval_cp));
        const percentage = ((clamped + 1000) / 2000) * 100;

        evalBar.css('height', percentage + '%');

        const displayEval = (eval_cp / 100).toFixed(1);
        evalText.text(displayEval);

        // Change text color based on position
        if (percentage > 60) {
            evalText.css('color', '#2c3e50');
        } else {
            evalText.css('color', 'white');
        }
    }

    function updateMoveDisplay() {
        const moveDisplay = $('#moveDisplay');
        const moveNum = Math.floor(currentMoveIndex / 2) + 1;
        const isWhite = currentMoveIndex % 2 === 0;

        if (currentMoveIndex === 0) {
            moveDisplay.text('Start');
        } else {
            const move = allMoves[currentMoveIndex - 1];
            moveDisplay.text(`Zug ${moveNum} (${isWhite ? 'Wei√ü' : 'Schwarz'})`);
        }

        // Update button states
        $('#btnStart').prop('disabled', currentMoveIndex === 0);
        $('#btnPrev').prop('disabled', currentMoveIndex === 0);
        $('#btnNext').prop('disabled', currentMoveIndex >= allMoves.length);
        $('#btnEnd').prop('disabled', currentMoveIndex >= allMoves.length);
    }

    function updateCoachExplanation() {
        const explanationDiv = $('#coachExplanation');

        if (currentMoveIndex === errorMoveNum - 1) {
            // Before error
            explanationDiv.html(`
                <h5 style="color: var(--accent);">‚ö†Ô∏è Achtung!</h5>
                <p class="mb-0">In dieser Position musst du vorsichtig sein. Der n√§chste Zug wird zum Fehler.</p>
            `);
        } else if (currentMoveIndex === errorMoveNum) {
            // After error - show full explanation
            const errorIcon = errorType === 'blunder' ? 'üí•' : errorType === 'mistake' ? '‚ö†Ô∏è' : 'üìä';
            const errorName = errorType === 'blunder' ? 'Grober Fehler' : errorType === 'mistake' ? 'Fehler' : 'Ungenauigkeit';

            explanationDiv.html(`
                <h5 style="color: var(--accent);">${errorIcon} ${errorName}</h5>
                <p class="mb-3" style="line-height: 1.6;">${errorExplanation}</p>
                <div class="text-center">
                    <small class="text-muted">Verlust: <strong style="color: #e74c3c;">${(cpLoss / 100).toFixed(1)}</strong> Bauern</small>
                </div>
            `);
        } else {
            // Normal position
            explanationDiv.html(`
                <h5 style="color: var(--accent);">Partie durchgehen</h5>
                <p class="mb-0">Nutze die Navigation oder Pfeiltasten (‚Üê ‚Üí) um durch die Partie zu gehen.</p>
            `);
        }
    }

    function drawErrorArrows() {
        clearArrows();

        const fromSquareYour = yourMove.slice(0, 2);
        const toSquareYour = yourMove.slice(2, 4);
        const fromSquareBest = bestMove.slice(0, 2);
        const toSquareBest = bestMove.slice(2, 4);

        drawArrow(fromSquareYour, toSquareYour, '#e74c3c');
        setTimeout(() => {
            drawArrow(fromSquareBest, toSquareBest, '#27ae60');
        }, 100);
    }

    function drawArrow(fromSq, toSq, color) {
        const boardEl = $('#board-wrapper');
        const squares = boardEl.find('.square-55d63');
        if (squares.length === 0) return;

        const squareSize = $(squares[0]).width();
        const fromPos = getSquareCenter(fromSq, squareSize);
        const toPos = getSquareCenter(toSq, squareSize);

        // Calculate arrow direction and shorten it
        const dx = toPos.x - fromPos.x;
        const dy = toPos.y - fromPos.y;
        const length = Math.sqrt(dx * dx + dy * dy);
        const shortenBy = squareSize * 0.35;
        const ratio = (length - shortenBy) / length;
        const endX = fromPos.x + dx * ratio;
        const endY = fromPos.y + dy * ratio;

        const svg = $(`
            <svg class="arrow" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10;">
                <defs>
                    <marker id="arrowhead-${color.replace('#', '')}" markerWidth="10" markerHeight="10" refX="6" refY="3" orient="auto">
                        <polygon points="0 0, 10 3, 0 6" fill="${color}" />
                    </marker>
                </defs>
                <line x1="${fromPos.x}" y1="${fromPos.y}"
                      x2="${endX}" y2="${endY}"
                      stroke="${color}"
                      stroke-width="8"
                      stroke-linecap="round"
                      opacity="0.85"
                      marker-end="url(#arrowhead-${color.replace('#', '')})" />
            </svg>
        `);

        boardEl.append(svg);
    }

    function getSquareCenter(square, squareSize) {
        const file = square.charCodeAt(0) - 'a'.charCodeAt(0);
        const rank = 8 - parseInt(square[1]);
        return {
            x: (file + 0.5) * squareSize,
            y: (rank + 0.5) * squareSize
        };
    }

    function clearArrows() {
        $('.arrow').remove();
        userArrows = [];
    }

    // Navigation
    $('#btnStart').on('click', () => {
        currentMoveIndex = 0;
        updateBoard();
    });

    $('#btnPrev').on('click', () => {
        if (currentMoveIndex > 0) {
            currentMoveIndex--;
            updateBoard();
        }
    });

    $('#btnNext').on('click', () => {
        if (currentMoveIndex < allMoves.length) {
            currentMoveIndex++;
            updateBoard();
        }
    });

    $('#btnEnd').on('click', () => {
        currentMoveIndex = allMoves.length;
        updateBoard();
    });

    // Keyboard navigation
    $(document).on('keydown', function(e) {
        if (e.key === 'ArrowLeft') {
            e.preventDefault();
            $('#btnPrev').click();
        } else if (e.key === 'ArrowRight') {
            e.preventDefault();
            $('#btnNext').click();
        }
    });

    // Right-click arrow drawing
    let rightClickStart = null;

    $('#board-wrapper').on('mousedown', '.square-55d63', function(e) {
        if (e.button === 2) {
            e.preventDefault();
            const square = $(this).attr('data-square');
            if (square) rightClickStart = square;
        }
    });

    $('#board-wrapper').on('mouseup', '.square-55d63', function(e) {
        if (e.button === 2 && rightClickStart) {
            e.preventDefault();
            const square = $(this).attr('data-square');
            if (square && square !== rightClickStart) {
                drawArrow(rightClickStart, square, 'rgba(230, 126, 34, 0.9)');
            }
            rightClickStart = null;
        }
    });

    $('#board-wrapper').on('contextmenu', function(e) {
        e.preventDefault();
        return false;
    });

    // Hover - show possible moves
    function onMouseoverSquare(square, piece) {
        if (!piece) return;

        const moves = game.moves({
            square: square,
            verbose: true
        });

        if (moves.length === 0) return;

        for (const move of moves) {
            highlightSquare(move.to, move.flags.includes('c'));
        }
    }

    function onMouseoutSquare() {
        $('.move-hint').remove();
    }

    function highlightSquare(square, isCapture) {
        const $square = $('#board .square-' + square);
        if ($square.length === 0) return;

        const squareEl = $square.get(0);
        const size = squareEl.offsetWidth;

        const hint = $('<div class="move-hint"></div>');

        if (isCapture) {
            hint.addClass('capture');
            hint.css({
                width: size + 'px',
                height: size + 'px',
                top: '0',
                left: '0'
            });
        } else {
            const dotSize = size * 0.25;
            hint.css({
                width: dotSize + 'px',
                height: dotSize + 'px',
                top: (size - dotSize) / 2 + 'px',
                left: (size - dotSize) / 2 + 'px'
            });
        }

        $square.css('position', 'relative').append(hint);
    }

    // Initialize at error position
    currentMoveIndex = errorMoveNum - 1;
    updateBoard();

    // Responsive
    $(window).resize(function() {
        board.resize();
        if (currentMoveIndex === errorMoveNum - 1) {
            setTimeout(() => {
                clearArrows();
                drawErrorArrows();
            }, 100);
        }
    });
});
</script>
{% endblock %}
