{% extends "base.html" %}

{% block title %}Fehler-Detail - Stockmeister{% endblock %}

{% block extra_head %}
<!-- jQuery (must load before chessboard.js) -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<!-- Chess.js for move validation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
<!-- Chessboard.js for board display -->
<link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

<style>
/* Chess.com style board colors */
.white-1e1d7 {
    background-color: #EEEED2 !important;
}

.black-3c85d {
    background-color: #769656 !important;
}

/* Orange highlights */
.highlight-white {
    background-color: rgba(230, 126, 34, 0.5) !important;
}

.highlight-black {
    background-color: rgba(230, 126, 34, 0.6) !important;
}

/* Board coordinates */
.notation-322f9 {
    font-weight: bold !important;
    font-size: 11px !important;
}

.white-1e1d7 .notation-322f9 {
    color: #769656 !important;
}

.black-3c85d .notation-322f9 {
    color: #EEEED2 !important;
}

/* Main layout */
.chess-layout {
    display: flex;
    gap: 1.5rem;
    align-items: flex-start;
}

.board-section {
    flex: 0 0 auto;
    max-width: 600px;
}

.sidebar-section {
    flex: 1;
    min-width: 350px;
}

/* Board wrapper */
#board {
    border-radius: 0.5rem;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

/* Coach card */
.coach-card {
    background: linear-gradient(135deg, var(--primary) 0%, #34495e 100%);
    border-radius: 1rem;
    padding: 1.5rem;
    margin-bottom: 1rem;
}

.coach-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.coach-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: 3px solid rgba(255, 255, 255, 0.3);
    object-fit: cover;
    object-position: center 30%;
}

.coach-bubble {
    background: rgba(255, 255, 255, 0.15);
    padding: 1rem;
    border-radius: 0.75rem;
    position: relative;
}

.coach-bubble::before {
    content: '';
    position: absolute;
    left: -8px;
    top: 15px;
    width: 0;
    height: 0;
    border-top: 8px solid transparent;
    border-bottom: 8px solid transparent;
    border-right: 8px solid rgba(255, 255, 255, 0.15);
}

/* Move list */
.move-list-card {
    background: rgba(44, 62, 80, 0.9);
    border-radius: 1rem;
    padding: 1.5rem;
    max-height: 500px;
    overflow-y: auto;
}

.move-list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.move-list {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.move-pair {
    display: grid;
    grid-template-columns: 40px 1fr 1fr;
    gap: 0.5rem;
    padding: 0.5rem;
    border-radius: 0.5rem;
    transition: background 0.2s;
}

.move-pair:hover {
    background: rgba(255, 255, 255, 0.05);
}

.move-number {
    color: rgba(255, 255, 255, 0.6);
    font-weight: 600;
    text-align: right;
    padding-right: 0.5rem;
}

.move-item {
    padding: 0.4rem 0.6rem;
    border-radius: 0.4rem;
    cursor: pointer;
    transition: all 0.2s;
    font-family: monospace;
    font-size: 0.95rem;
    color: rgba(255, 255, 255, 0.9);
}

.move-item:hover {
    background: rgba(230, 126, 34, 0.2);
}

.move-item.active {
    background: var(--accent);
    color: white;
    font-weight: bold;
}

.move-item.error-move {
    background: rgba(231, 76, 60, 0.3);
    border: 2px solid #e74c3c;
    position: relative;
}

.move-item.error-move::after {
    content: '‚ùå';
    position: absolute;
    right: 4px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 0.8rem;
}

/* Navigation controls */
.nav-controls {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
    margin-top: 1rem;
}

.nav-btn {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    padding: 0.6rem 1rem;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 1.1rem;
}

.nav-btn:hover:not(:disabled) {
    background: rgba(230, 126, 34, 0.3);
    border-color: var(--accent);
}

.nav-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
}

/* Arrows */
.arrow {
    position: absolute;
    pointer-events: none;
    z-index: 10;
}

/* Move hints */
.move-hint {
    position: absolute;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.15);
    pointer-events: none;
    z-index: 5;
}

.move-hint.capture {
    border: 4px solid rgba(0, 0, 0, 0.15);
    background: transparent;
}

/* Scrollbar styling */
.move-list-card::-webkit-scrollbar {
    width: 8px;
}

.move-list-card::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 4px;
}

.move-list-card::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 4px;
}

.move-list-card::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.4);
}

/* Responsive */
@media (max-width: 1200px) {
    .chess-layout {
        flex-direction: column;
    }

    .board-section {
        max-width: 100%;
    }

    .sidebar-section {
        width: 100%;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col">
        <a href="{{ url_for('errors') }}" class="btn btn-sm btn-outline-light">‚Üê Zur√ºck zur √úbersicht</a>
    </div>
</div>

<div class="chess-layout">
    <!-- Left: Chess Board -->
    <div class="board-section">
        <div id="board-wrapper" style="position: relative;">
            <div id="board" style="width: 100%;"></div>
        </div>

        <!-- Navigation Controls -->
        <div class="nav-controls">
            <button class="nav-btn" id="btnStart" title="Zum Anfang">‚èÆ</button>
            <button class="nav-btn" id="btnPrev" title="Zur√ºck">‚óÄ</button>
            <button class="nav-btn" id="btnNext" title="Vor">‚ñ∂</button>
            <button class="nav-btn" id="btnEnd" title="Zum Ende">‚è≠</button>
        </div>

        <div class="text-center mt-2">
            <small class="text-muted">
                ‚Üê ‚Üí Pfeiltasten | Rechtsklick = Pfeile zeichnen
            </small>
        </div>
    </div>

    <!-- Right: Coach + Move List -->
    <div class="sidebar-section">
        <!-- Coach Card -->
        <div class="coach-card">
            <div class="coach-header">
                <img src="{{ url_for('static', filename='images/coach.jpg') }}"
                     alt="Stockmeister"
                     class="coach-avatar">
                <div>
                    <h6 class="mb-0" style="color: var(--accent); font-weight: 600;">Stockmeister</h6>
                    <small class="text-white-50">
                        {% if error.error_type == 'blunder' %}
                            üí• Grober Fehler
                        {% elif error.error_type == 'mistake' %}
                            ‚ö†Ô∏è Fehler
                        {% else %}
                            üìä Ungenauigkeit
                        {% endif %}
                    </small>
                </div>
            </div>

            <div class="coach-bubble" id="coachExplanation">
                <!-- Dynamic explanation -->
            </div>
        </div>

        <!-- Move List Card -->
        <div class="move-list-card">
            <div class="move-list-header">
                <h6 class="mb-0" style="color: white;">Z√ºge</h6>
                <small class="text-muted" id="currentMoveInfo">Zug 1</small>
            </div>

            <div class="move-list" id="moveList">
                <!-- Moves will be generated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Game data from server
    const allMoves = {{ moves|tojson }};
    const errorMoveNum = {{ error.move_number }};
    const yourMove = '{{ error.move_played }}';
    const bestMove = '{{ error.best_move }}';
    const errorExplanation = {{ error.explanation|tojson }};
    const errorType = '{{ error.error_type }}';
    const cpLoss = {{ error.centipawn_loss }};

    // State
    let currentMoveIndex = 0;
    let board = null;
    let game = new Chess();

    // Initialize board
    const config = {
        draggable: false,
        position: 'start',
        pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png',
        onMouseoutSquare: onMouseoutSquare,
        onMouseoverSquare: onMouseoverSquare
    };

    board = Chessboard('board', config);

    // Build move list
    function buildMoveList() {
        const moveListEl = $('#moveList');
        moveListEl.empty();

        for (let i = 0; i < allMoves.length; i += 2) {
            const moveNum = Math.floor(i / 2) + 1;
            const whiteMove = allMoves[i];
            const blackMove = allMoves[i + 1];

            const pair = $(`
                <div class="move-pair">
                    <div class="move-number">${moveNum}.</div>
                    <div class="move-item ${i + 1 === errorMoveNum ? 'error-move' : ''}" data-move="${i + 1}">
                        ${whiteMove.san}
                    </div>
                    ${blackMove ? `<div class="move-item ${i + 2 === errorMoveNum ? 'error-move' : ''}" data-move="${i + 2}">${blackMove.san}</div>` : '<div></div>'}
                </div>
            `);

            moveListEl.append(pair);
        }

        // Click handler for moves
        $('.move-item').on('click', function() {
            const moveIndex = parseInt($(this).attr('data-move'));
            currentMoveIndex = moveIndex;
            updateBoard();
        });
    }

    // Update board to current move
    function updateBoard() {
        game.reset();

        for (let i = 0; i < currentMoveIndex; i++) {
            game.move(allMoves[i].uci);
        }

        board.position(game.fen());
        updateMoveList();
        updateCurrentMoveInfo();
        updateCoachExplanation();
        clearArrows();

        // Show error arrows at error position
        if (currentMoveIndex === errorMoveNum - 1) {
            setTimeout(() => {
                drawErrorArrows();
            }, 200);
        }

        // Scroll to current move
        scrollToCurrentMove();
    }

    function updateMoveList() {
        $('.move-item').removeClass('active');
        if (currentMoveIndex > 0) {
            $(`.move-item[data-move="${currentMoveIndex}"]`).addClass('active');
        }

        // Update button states
        $('#btnStart').prop('disabled', currentMoveIndex === 0);
        $('#btnPrev').prop('disabled', currentMoveIndex === 0);
        $('#btnNext').prop('disabled', currentMoveIndex >= allMoves.length);
        $('#btnEnd').prop('disabled', currentMoveIndex >= allMoves.length);
    }

    function updateCurrentMoveInfo() {
        const infoEl = $('#currentMoveInfo');
        if (currentMoveIndex === 0) {
            infoEl.text('Startposition');
        } else {
            const moveNum = Math.floor((currentMoveIndex - 1) / 2) + 1;
            const color = currentMoveIndex % 2 === 1 ? 'Wei√ü' : 'Schwarz';
            infoEl.text(`Zug ${moveNum} - ${color}`);
        }
    }

    function updateCoachExplanation() {
        const explanationDiv = $('#coachExplanation');

        if (currentMoveIndex === errorMoveNum - 1) {
            // Before error
            explanationDiv.html(`
                <p class="mb-2" style="color: var(--accent); font-weight: 600;">‚ö†Ô∏è Achtung!</p>
                <p class="mb-0" style="font-size: 0.95rem; line-height: 1.5;">In dieser Position musst du vorsichtig sein. Der n√§chste Zug wird zum Fehler.</p>
            `);
        } else if (currentMoveIndex === errorMoveNum) {
            // After error - show full explanation
            const errorIcon = errorType === 'blunder' ? 'üí•' : errorType === 'mistake' ? '‚ö†Ô∏è' : 'üìä';
            const errorName = errorType === 'blunder' ? 'Grober Fehler' : errorType === 'mistake' ? 'Fehler' : 'Ungenauigkeit';

            explanationDiv.html(`
                <p class="mb-2" style="color: var(--accent); font-weight: 600;">${errorIcon} ${errorName}</p>
                <p class="mb-2" style="font-size: 0.95rem; line-height: 1.5;">${errorExplanation}</p>
                <small class="text-muted">Verlust: <strong style="color: #e74c3c;">${(cpLoss / 100).toFixed(1)}</strong> Bauern</small>
            `);
        } else {
            // Normal position
            explanationDiv.html(`
                <p class="mb-2" style="color: var(--accent); font-weight: 600;">Partie durchgehen</p>
                <p class="mb-0" style="font-size: 0.95rem;">Klicke auf einen Zug in der Liste oder nutze die Pfeiltasten (‚Üê ‚Üí).</p>
            `);
        }
    }

    function scrollToCurrentMove() {
        const activeMove = $('.move-item.active');
        if (activeMove.length > 0) {
            const container = $('.move-list-card');
            const scrollTop = activeMove.offset().top - container.offset().top + container.scrollTop() - 100;
            container.animate({ scrollTop: scrollTop }, 300);
        }
    }

    function drawErrorArrows() {
        clearArrows();

        const fromSquareYour = yourMove.slice(0, 2);
        const toSquareYour = yourMove.slice(2, 4);
        const fromSquareBest = bestMove.slice(0, 2);
        const toSquareBest = bestMove.slice(2, 4);

        drawArrow(fromSquareYour, toSquareYour, '#e74c3c');
        setTimeout(() => {
            drawArrow(fromSquareBest, toSquareBest, '#27ae60');
        }, 100);
    }

    function drawArrow(fromSq, toSq, color) {
        const boardEl = $('#board-wrapper');
        const squares = boardEl.find('.square-55d63');
        if (squares.length === 0) return;

        const squareSize = $(squares[0]).width();
        const fromPos = getSquareCenter(fromSq, squareSize);
        const toPos = getSquareCenter(toSq, squareSize);

        const dx = toPos.x - fromPos.x;
        const dy = toPos.y - fromPos.y;
        const length = Math.sqrt(dx * dx + dy * dy);
        const shortenBy = squareSize * 0.35;
        const ratio = (length - shortenBy) / length;
        const endX = fromPos.x + dx * ratio;
        const endY = fromPos.y + dy * ratio;

        const svg = $(`
            <svg class="arrow" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10;">
                <defs>
                    <marker id="arrowhead-${color.replace('#', '')}" markerWidth="10" markerHeight="10" refX="6" refY="3" orient="auto">
                        <polygon points="0 0, 10 3, 0 6" fill="${color}" />
                    </marker>
                </defs>
                <line x1="${fromPos.x}" y1="${fromPos.y}"
                      x2="${endX}" y2="${endY}"
                      stroke="${color}"
                      stroke-width="8"
                      stroke-linecap="round"
                      opacity="0.85"
                      marker-end="url(#arrowhead-${color.replace('#', '')})" />
            </svg>
        `);

        boardEl.append(svg);
    }

    function getSquareCenter(square, squareSize) {
        const file = square.charCodeAt(0) - 'a'.charCodeAt(0);
        const rank = 8 - parseInt(square[1]);
        return {
            x: (file + 0.5) * squareSize,
            y: (rank + 0.5) * squareSize
        };
    }

    function clearArrows() {
        $('.arrow').remove();
    }

    // Navigation
    $('#btnStart').on('click', () => {
        currentMoveIndex = 0;
        updateBoard();
    });

    $('#btnPrev').on('click', () => {
        if (currentMoveIndex > 0) {
            currentMoveIndex--;
            updateBoard();
        }
    });

    $('#btnNext').on('click', () => {
        if (currentMoveIndex < allMoves.length) {
            currentMoveIndex++;
            updateBoard();
        }
    });

    $('#btnEnd').on('click', () => {
        currentMoveIndex = allMoves.length;
        updateBoard();
    });

    // Keyboard navigation
    $(document).on('keydown', function(e) {
        if (e.key === 'ArrowLeft') {
            e.preventDefault();
            $('#btnPrev').click();
        } else if (e.key === 'ArrowRight') {
            e.preventDefault();
            $('#btnNext').click();
        }
    });

    // Right-click arrow drawing
    let rightClickStart = null;

    $('#board-wrapper').on('mousedown', '.square-55d63', function(e) {
        if (e.button === 2) {
            e.preventDefault();
            const square = $(this).attr('data-square');
            if (square) rightClickStart = square;
        }
    });

    $('#board-wrapper').on('mouseup', '.square-55d63', function(e) {
        if (e.button === 2 && rightClickStart) {
            e.preventDefault();
            const square = $(this).attr('data-square');
            if (square && square !== rightClickStart) {
                drawArrow(rightClickStart, square, 'rgba(230, 126, 34, 0.9)');
            }
            rightClickStart = null;
        }
    });

    $('#board-wrapper').on('contextmenu', function(e) {
        e.preventDefault();
        return false;
    });

    // Hover - show possible moves
    function onMouseoverSquare(square, piece) {
        if (!piece) return;

        const moves = game.moves({
            square: square,
            verbose: true
        });

        if (moves.length === 0) return;

        for (const move of moves) {
            highlightSquare(move.to, move.flags.includes('c'));
        }
    }

    function onMouseoutSquare() {
        $('.move-hint').remove();
    }

    function highlightSquare(square, isCapture) {
        const $square = $('#board .square-' + square);
        if ($square.length === 0) return;

        const squareEl = $square.get(0);
        const size = squareEl.offsetWidth;

        const hint = $('<div class="move-hint"></div>');

        if (isCapture) {
            hint.addClass('capture');
            hint.css({
                width: size + 'px',
                height: size + 'px',
                top: '0',
                left: '0'
            });
        } else {
            const dotSize = size * 0.25;
            hint.css({
                width: dotSize + 'px',
                height: dotSize + 'px',
                top: (size - dotSize) / 2 + 'px',
                left: (size - dotSize) / 2 + 'px'
            });
        }

        $square.css('position', 'relative').append(hint);
    }

    // Initialize
    buildMoveList();
    currentMoveIndex = errorMoveNum - 1;
    updateBoard();

    // Responsive
    $(window).resize(function() {
        board.resize();
        if (currentMoveIndex === errorMoveNum - 1) {
            setTimeout(() => {
                clearArrows();
                drawErrorArrows();
            }, 100);
        }
    });
});
</script>
{% endblock %}
