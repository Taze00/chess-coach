{% extends "base.html" %}

{% block title %}Fehler-Analyse - Stockmeister{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="mb-3">Fehler-Analyse</h1>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <div class="display-4 mb-2" style="color: #e74c3c;">ğŸ’¥</div>
                <h5>Grobe Fehler</h5>
                <p class="display-6 mb-0">{{ categorized.blunders|length }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <div class="display-4 mb-2" style="color: #f39c12;">âš ï¸</div>
                <h5>Fehler</h5>
                <p class="display-6 mb-0">{{ categorized.mistakes|length }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <div class="display-4 mb-2" style="color: #3498db;">ğŸ“Š</div>
                <h5>Ungenauigkeiten</h5>
                <p class="display-6 mb-0">{{ categorized.inaccuracies|length }}</p>
            </div>
        </div>
    </div>
</div>

{% if pattern_filter %}
<!-- Active Pattern Filter -->
<div class="row mb-3">
    <div class="col">
        <div class="alert" style="background: rgba(255, 107, 53, 0.2); border: 1px solid var(--accent); color: white;">
            ğŸ¯ Gefiltert nach: <strong>{{ pattern_translations.get(pattern_filter, pattern_filter) }}</strong>
            <a href="{{ url_for('errors') }}" class="btn btn-sm btn-outline-light ms-2" style="float: right;">Filter entfernen</a>
        </div>
    </div>
</div>
{% endif %}

{% if errors %}
<!-- Filter Section -->
<div class="row mb-3">
    <div class="col">
        <div class="card">
            <div class="card-body">
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-sm btn-outline-light filter-btn active" data-filter="all">Alle</button>
                    <button class="btn btn-sm btn-outline-danger filter-btn" data-filter="blunder">ğŸ’¥ Grobe Fehler</button>
                    <button class="btn btn-sm btn-outline-warning filter-btn" data-filter="mistake">âš ï¸ Fehler</button>
                    <button class="btn btn-sm btn-outline-info filter-btn" data-filter="inaccuracy">ğŸ“Š Ungenauigkeiten</button>
                    <div class="ms-auto">
                        <select id="sortSelect" class="form-select form-select-sm" style="width: auto;">
                            <option value="newest">Neueste zuerst</option>
                            <option value="oldest">Ã„lteste zuerst</option>
                            <option value="severity">Schwerwiegendste</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Errors List -->
<div class="row">
    <div class="col">
        <div class="card">
            <div class="card-body">
                <h5 class="mb-3">Deine Fehler</h5>
                <div class="error-list" id="errorList">
                    {% for error in errors %}
                    <a href="{{ url_for('error_detail', error_id=error.id) }}"
                       class="error-item"
                       data-type="{{ error.error_type }}"
                       data-loss="{{ error.centipawn_loss }}"
                       data-id="{{ error.id }}">
                        <div class="error-icon">
                            {% if error.error_type == 'blunder' %}
                                ğŸ’¥
                            {% elif error.error_type == 'mistake' %}
                                âš ï¸
                            {% else %}
                                ğŸ“Š
                            {% endif %}
                        </div>
                        <div class="error-content">
                            <div class="error-title">
                                <strong>Zug {{ error.move_number }}</strong>
                                <span class="error-badge error-badge-{{ error.error_type }}">
                                    -{{ (error.centipawn_loss / 100)|round(1) }}
                                </span>
                            </div>
                            <div class="error-description">
                                {{ error.explanation }}
                            </div>
                            {% if error.tactical_patterns %}
                            <div class="error-patterns mt-2">
                                {% set patterns = error.get_tactical_patterns_list() %}
                                {% for pattern in patterns[:3] %}
                                    <span class="badge bg-secondary-subtle text-secondary me-1">
                                        {{ pattern_translations.get(pattern, pattern) }}
                                    </span>
                                {% endfor %}
                                {% if patterns|length > 3 %}
                                    <span class="badge bg-secondary-subtle text-secondary">+{{ patterns|length - 3 }}</span>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                        <div class="error-arrow">â†’</div>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<!-- Empty State -->
<div class="row">
    <div class="col">
        <div class="text-center py-5">
            <span class="display-1">ğŸ”</span>
            <p class="lead mt-3">Noch keine Fehler gefunden</p>
            <p class="text-muted">Gehe zum Dashboard und importiere & analysiere deine Spiele</p>
            <a href="{{ url_for('dashboard') }}" class="btn btn-primary">Zum Dashboard</a>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Filter and Sort functionality
const errorList = document.getElementById('errorList');
const filterBtns = document.querySelectorAll('.filter-btn');
const sortSelect = document.getElementById('sortSelect');
let currentFilter = 'all';
let currentSort = 'newest';

// Filter errors
filterBtns.forEach(btn => {
    btn.addEventListener('click', function() {
        // Update active state
        filterBtns.forEach(b => b.classList.remove('active'));
        this.classList.add('active');

        // Update filter
        currentFilter = this.dataset.filter;
        applyFiltersAndSort();
    });
});

// Sort errors
sortSelect.addEventListener('change', function() {
    currentSort = this.value;
    applyFiltersAndSort();
});

function applyFiltersAndSort() {
    const items = Array.from(errorList.querySelectorAll('.error-item'));

    // Filter
    items.forEach(item => {
        const type = item.dataset.type;
        if (currentFilter === 'all' || type === currentFilter) {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });

    // Sort visible items
    const visibleItems = items.filter(item => item.style.display !== 'none');

    visibleItems.sort((a, b) => {
        if (currentSort === 'newest') {
            return parseInt(b.dataset.id) - parseInt(a.dataset.id);
        } else if (currentSort === 'oldest') {
            return parseInt(a.dataset.id) - parseInt(b.dataset.id);
        } else if (currentSort === 'severity') {
            return parseInt(b.dataset.loss) - parseInt(a.dataset.loss);
        }
    });

    // Reorder in DOM
    visibleItems.forEach(item => {
        errorList.appendChild(item);
    });
}
</script>
{% endblock %}
