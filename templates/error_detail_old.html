{% extends "base.html" %}

{% block title %}Fehler-Detail - Stockmeister{% endblock %}

{% block extra_head %}
<!-- jQuery (must load before chessboard.js) -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<!-- Chess.js for move validation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
<!-- Chessboard.js for board display -->
<link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

<style>
/* Override chessboard.js default colors with custom theme */
.white-1e1d7 {
    background-color: #95a5a6 !important; /* Light squares */
}

.black-3c85d {
    background-color: #2c3e50 !important; /* Dark squares - matches primary color */
}

/* Orange highlights for hover/selection */
.highlight-white {
    background-color: rgba(230, 126, 34, 0.5) !important;
}

.highlight-black {
    background-color: rgba(230, 126, 34, 0.6) !important;
}

/* Board container */
#board {
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.5rem;
    overflow: hidden;
    position: relative;
}

/* Move arrows */
.move-arrow {
    position: absolute;
    pointer-events: none;
    z-index: 10;
}

.arrow-your-move {
    stroke: #e74c3c;
    stroke-width: 15;
    fill: #e74c3c;
    opacity: 0.9;
    filter: drop-shadow(0 0 3px rgba(231, 76, 60, 0.8));
}

.arrow-best-move {
    stroke: #27ae60;
    stroke-width: 15;
    fill: #27ae60;
    opacity: 0.9;
    filter: drop-shadow(0 0 3px rgba(39, 174, 96, 0.8));
}

/* Arrow markers */
.arrow-head-red {
    fill: #e74c3c;
}

.arrow-head-green {
    fill: #27ae60;
}
</style>
{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col">
        <a href="{{ url_for('errors') }}" class="btn btn-sm btn-outline-light">‚Üê Zur√ºck zur √úbersicht</a>
    </div>
</div>

<div class="row">
    <div class="col-lg-7 mb-4">
        <!-- Chess Board -->
        <div class="card">
            <div class="card-body">
                <h5 class="mb-3">Stellung</h5>
                <div class="chess-board-container">
                    <div id="board" style="width: 100%;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-5">

        <!-- Coach Explanation -->
        <div class="card mb-3" style="background: linear-gradient(135deg, var(--primary) 0%, #34495e 100%);">
            <div class="card-body">
                <div class="d-flex align-items-start gap-3">
                    <div style="flex-shrink: 0;">
                        <img src="{{ url_for('static', filename='images/coach.jpg') }}"
                             alt="Stockmeister"
                             style="width: 60px; height: 60px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.3); object-fit: cover; object-position: center 30%;">
                    </div>
                    <div style="flex: 1;">
                        <div style="background: rgba(255,255,255,0.15); padding: 1.25rem; border-radius: 1rem; position: relative;">
                            <!-- Speech bubble arrow -->
                            <div style="position: absolute; left: -10px; top: 20px; width: 0; height: 0;
                                        border-top: 10px solid transparent;
                                        border-bottom: 10px solid transparent;
                                        border-right: 10px solid rgba(255,255,255,0.15);"></div>

                            <h5 class="mb-3" style="color: var(--accent);">
                                {% if error.error_type == 'blunder' %}
                                    üí• Grober Fehler in Zug {{ error.move_number }}
                                {% elif error.error_type == 'mistake' %}
                                    ‚ö†Ô∏è Fehler in Zug {{ error.move_number }}
                                {% else %}
                                    üìä Ungenauigkeit in Zug {{ error.move_number }}
                                {% endif %}
                            </h5>

                            <p class="mb-0" style="line-height: 1.6;">{{ error.explanation|safe }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
$(document).ready(function() {
    // Game state
    const initialPosition = '{{ error.position }}';
    const bestMove = '{{ error.best_move }}';
    const yourMove = '{{ error.move_played }}';

    const game = new Chess(initialPosition);
    let board = null;
    let currentArrows = [];

    // Helper: Draw simple arrow like chess.com
    function drawArrow(from, to, color) {
        const boardEl = $('#board');
        const squares = boardEl.find('.square-55d63');
        if (squares.length === 0) return;

        const squareSize = $(squares[0]).width();

        // Get square positions (center of squares)
        function getSquareCenter(square) {
            const file = square.charCodeAt(0) - 'a'.charCodeAt(0);
            const rank = 8 - parseInt(square[1]);
            return {
                x: (file + 0.5) * squareSize,
                y: (rank + 0.5) * squareSize
            };
        }

        const fromPos = getSquareCenter(from);
        const toPos = getSquareCenter(to);

        // Simple colors - red and green
        const arrowColor = color === 'red' ? 'rgba(255, 0, 0, 0.8)' : 'rgba(0, 255, 0, 0.8)';

        // Create simple SVG arrow
        const svg = $(`
            <svg class="move-arrow" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100;">
                <defs>
                    <marker id="arrowhead-${color}" markerWidth="4" markerHeight="8" refX="2.6" refY="2.5" orient="auto">
                        <path d="M0,0 L0,5 L3,2.5 z" fill="${arrowColor}" />
                    </marker>
                </defs>
                <line x1="${fromPos.x}"
                      y1="${fromPos.y}"
                      x2="${toPos.x}"
                      y2="${toPos.y}"
                      stroke="${arrowColor}"
                      stroke-width="${squareSize * 0.16}"
                      stroke-linecap="round"
                      marker-end="url(#arrowhead-${color})" />
            </svg>
        `);

        boardEl.append(svg);
        currentArrows.push(svg);
    }

    // Helper: Remove arrows
    function removeArrows() {
        $('.move-arrow').remove();
        currentArrows = [];
    }

    // Helper: Highlight squares
    function removeHighlights() {
        $('#board .square-55d63').removeClass('highlight-white highlight-black');
    }

    function highlightSquares(from, to, color) {
        removeHighlights();
        const highlightClass = color === 'red' ? 'highlight-white' : 'highlight-black';
        $('#board .square-' + from).addClass(highlightClass);
        $('#board .square-' + to).addClass(highlightClass);
    }

    // Helper for validating and making moves
    function onDrop(source, target) {
        // Try to make the move
        const move = game.move({
            from: source,
            to: target,
            promotion: 'q'
        });

        // Illegal move
        if (move === null) return 'snapback';

        // Legal move - update board
        removeArrows();
    }

    // Board configuration
    const config = {
        draggable: true,
        position: initialPosition,
        pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png',
        onDrop: onDrop,
        onSnapEnd: function() {
            board.position(game.fen());
        }
    };

    // Initialize board
    board = Chessboard('board', config);

    // Function to show both moves
    function showBothMoves() {
        removeArrows();

        // Draw orange arrow for your move
        drawArrow(yourMove.slice(0, 2), yourMove.slice(2, 4), 'red');

        // Draw green arrow for best move
        setTimeout(function() {
            drawArrow(bestMove.slice(0, 2), bestMove.slice(2, 4), 'green');
        }, 100);
    }

    // Show both moves automatically on load
    setTimeout(function() {
        showBothMoves();
    }, 500);

    // Reset to initial position
    function resetPosition() {
        game.load(initialPosition);
        board.position(initialPosition);
        setTimeout(function() {
            showBothMoves();
        }, 100);
    }


    // Responsive board
    $(window).resize(function() {
        board.resize();
        removeArrows();
        setTimeout(function() {
            showBothMoves();
        }, 100);
    });

    // Keyboard shortcuts
    $(document).on('keydown', function(e) {
        switch(e.key) {
            case 'r':
            case 'R':
                e.preventDefault();
                resetPosition();
                break;
        }
    });
});
</script>
{% endblock %}
