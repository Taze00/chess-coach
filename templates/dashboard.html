{% extends "base.html" %}

{% block title %}Dashboard - Chess Coach{% endblock %}

{% block content %}
<div class="new-dashboard">
    <!-- Header with Streak -->
    <div class="dashboard-header">
        <div class="header-left">
            <h1>Dashboard</h1>
            <p class="text-muted">Willkommen zur√ºck, {{ current_user.chesscom_username }}!</p>
        </div>
        <div class="header-right">
            <div class="streak-badge" id="streakBadge">
                <div class="streak-icon">üî•</div>
                <div class="streak-info">
                    <div class="streak-number" id="streakNumber">-</div>
                    <div class="streak-label">Tage Streak</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Week Comparison -->
    <div class="week-comparison-card">
        <h5 class="section-title">üìä W√∂chentlicher Fortschritt</h5>
        <div class="week-grid">
            <!-- Current Week -->
            <div class="week-column">
                <div class="week-label">Diese Woche</div>
                <div class="week-stats">
                    <div class="week-stat">
                        <span class="stat-icon">üéØ</span>
                        <span class="stat-value" id="currentWeekPuzzles">-</span>
                        <span class="stat-label">Puzzles</span>
                    </div>
                    <div class="week-stat">
                        <span class="stat-icon">‚úÖ</span>
                        <span class="stat-value" id="currentWeekSuccess">-</span>
                        <span class="stat-label">Erfolg</span>
                    </div>
                    <div class="week-stat">
                        <span class="stat-icon">‚è±Ô∏è</span>
                        <span class="stat-value" id="currentWeekTime">-</span>
                        <span class="stat-label">√ò Zeit</span>
                    </div>
                </div>
            </div>

            <!-- Comparison Arrow -->
            <div class="week-divider">‚Üí</div>

            <!-- Last Week with Comparison -->
            <div class="week-column">
                <div class="week-label">Letzte Woche</div>
                <div class="week-stats">
                    <div class="week-stat">
                        <span class="stat-icon">üéØ</span>
                        <span class="stat-value" id="lastWeekPuzzles">-</span>
                        <span class="change-badge" id="puzzlesChange">-</span>
                    </div>
                    <div class="week-stat">
                        <span class="stat-icon">‚úÖ</span>
                        <span class="stat-value" id="lastWeekSuccess">-</span>
                        <span class="change-badge" id="successChange">-</span>
                    </div>
                    <div class="week-stat">
                        <span class="stat-icon">‚è±Ô∏è</span>
                        <span class="stat-value" id="lastWeekTime">-</span>
                        <span class="change-badge" id="timeChange">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="dashboard-grid">
        <!-- Left Column -->
        <div class="dashboard-left">
            <!-- Weaknesses Card -->
            <div class="dashboard-card weakness-card">
                <h5 class="section-title">‚ö†Ô∏è Deine Schwachstellen</h5>
                <p class="text-muted small mb-3">Fokussiere dich auf diese Pattern zum Verbessern</p>
                <div id="weaknessesList" class="weaknesses-list">
                    <div class="text-center text-muted py-3">Lade Daten...</div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="dashboard-card quick-stats-card">
                <h5 class="section-title">üìà Gesamtstatistiken</h5>
                <div class="quick-stats-grid">
                    <div class="quick-stat">
                        <div class="stat-icon">üéØ</div>
                        <div class="stat-content">
                            <div class="stat-value" id="totalSolved">-</div>
                            <div class="stat-label">Gesamt gel√∂st</div>
                        </div>
                    </div>
                    <div class="quick-stat">
                        <div class="stat-icon">üí™</div>
                        <div class="stat-content">
                            <div class="stat-value" id="successRate">-</div>
                            <div class="stat-label">Erfolgsrate</div>
                        </div>
                    </div>
                    <div class="quick-stat">
                        <div class="stat-icon">üìã</div>
                        <div class="stat-content">
                            <div class="stat-value" id="totalGames">-</div>
                            <div class="stat-label">Spiele</div>
                        </div>
                    </div>
                    <div class="quick-stat">
                        <div class="stat-icon">üîç</div>
                        <div class="stat-content">
                            <div class="stat-value" id="totalErrors">-</div>
                            <div class="stat-label">Fehler</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Achievements -->
            <div class="dashboard-card achievements-card">
                <h5 class="section-title">üèÜ Meilensteine</h5>
                <div id="achievementsList" class="achievements-list">
                    <div class="text-center text-muted py-3">Lade Daten...</div>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="dashboard-right">
            <!-- Recent Activity -->
            <div class="dashboard-card activity-card">
                <h5 class="section-title">üìú Letzte Aktivit√§ten</h5>
                <div id="recentActivityList" class="activity-list">
                    <div class="text-center text-muted py-3">Lade Daten...</div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="dashboard-card actions-card">
                <h5 class="section-title">‚ö° Schnellaktionen</h5>
                <div class="actions-grid">
                    <a href="{{ url_for('training') }}" class="action-button">
                        <div class="action-icon">üéØ</div>
                        <div class="action-text">Training starten</div>
                    </a>
                    <a href="{{ url_for('analytics') }}" class="action-button">
                        <div class="action-icon">üìä</div>
                        <div class="action-text">Analytics</div>
                    </a>
                    <a href="{{ url_for('errors') }}" class="action-button">
                        <div class="action-icon">üîç</div>
                        <div class="action-text">Fehler ansehen</div>
                    </a>
                    <button id="importAnalyzeBtn" class="action-button">
                        <div class="action-icon">üé≤</div>
                        <div class="action-text">Spiele analysieren</div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Bar for Import -->
    <div id="analysisProgress" style="display: none; margin-top: 20px;">
        <div class="progress" style="height: 25px; background-color: rgba(255,255,255,0.1);">
            <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%; background-color: var(--accent);">
                <span id="progressText">0%</span>
            </div>
        </div>
        <small id="progressDetails" class="text-muted d-block mt-2 text-center">Analysiere Spiele...</small>
    </div>
</div>

<style>
.new-dashboard {
    max-width: 1600px;
    margin: 0 auto;
    padding: 2rem;
}

/* Header */
.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.header-left h1 {
    margin-bottom: 0.25rem;
    color: #fff;
}

.streak-badge {
    display: flex;
    align-items: center;
    gap: 1rem;
    background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
    padding: 1rem 1.5rem;
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
}

.streak-icon {
    font-size: 2.5rem;
    animation: flicker 2s infinite;
}

@keyframes flicker {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; transform: scale(1.1); }
}

.streak-number {
    font-size: 2rem;
    font-weight: bold;
    color: #fff;
    line-height: 1;
}

.streak-label {
    font-size: 0.85rem;
    color: rgba(255,255,255,0.9);
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* Week Comparison Card */
.week-comparison-card {
    background: linear-gradient(135deg, rgba(0, 188, 212, 0.1) 0%, rgba(0, 188, 212, 0.05) 100%);
    border: 1px solid rgba(0, 188, 212, 0.3);
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.section-title {
    color: #fff;
    margin-bottom: 1rem;
    font-weight: 600;
}

.week-grid {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 2rem;
    align-items: center;
}

.week-column {
    text-align: center;
}

.week-label {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--accent);
    margin-bottom: 1rem;
}

.week-stats {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.week-stat {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
}

.week-stat .stat-icon {
    font-size: 1.5rem;
}

.week-stat .stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #fff;
    min-width: 80px;
    text-align: left;
}

.week-stat .stat-label {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-left: auto;
}

.week-divider {
    font-size: 2rem;
    color: var(--accent);
}

.change-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.85rem;
    margin-left: auto;
}

.change-badge.positive {
    background-color: rgba(76, 175, 80, 0.2);
    color: #4CAF50;
}

.change-badge.negative {
    background-color: rgba(244, 67, 54, 0.2);
    color: #F44336;
}

.change-badge.neutral {
    background-color: rgba(158, 158, 158, 0.2);
    color: #9E9E9E;
}

/* Dashboard Grid */
.dashboard-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
}

.dashboard-card {
    background: var(--card-bg);
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.dashboard-left, .dashboard-right {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

/* Weaknesses */
.weaknesses-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.weakness-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
    border-left: 4px solid #F44336;
}

.weakness-info {
    flex: 1;
}

.weakness-name {
    font-weight: 600;
    color: #fff;
    font-size: 1rem;
}

.weakness-rate {
    font-size: 0.85rem;
    color: var(--text-muted);
}

.weakness-badge {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 600;
    background-color: rgba(244, 67, 54, 0.2);
    color: #F44336;
    margin-right: 1rem;
}

.train-btn {
    padding: 0.5rem 1rem;
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    text-decoration: none;
    display: inline-block;
    transition: transform 0.2s ease;
}

.train-btn:hover {
    transform: translateY(-2px);
    color: #fff;
}

/* Quick Stats */
.quick-stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.quick-stat {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
}

.quick-stat .stat-icon {
    font-size: 2rem;
}

.quick-stat .stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--accent);
}

.quick-stat .stat-label {
    font-size: 0.85rem;
    color: var(--text-muted);
}

/* Achievements */
.achievements-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.achievement-item {
    padding: 1rem;
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
}

.achievement-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
}

.achievement-title {
    font-weight: 600;
    color: #fff;
}

.achievement-progress {
    color: var(--accent);
    font-weight: 600;
}

.progress-bar-container {
    width: 100%;
    height: 8px;
    background: rgba(255,255,255,0.1);
    border-radius: 4px;
    overflow: hidden;
}

.progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), #4CAF50);
    border-radius: 4px;
    transition: width 0.3s ease;
}

/* Activity */
.activity-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    max-height: 400px;
    overflow-y: auto;
}

.activity-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    background: rgba(255,255,255,0.05);
    border-radius: 8px;
}

.activity-icon {
    font-size: 1.5rem;
}

.activity-info {
    flex: 1;
}

.activity-text {
    color: #fff;
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
}

.activity-meta {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.activity-time {
    font-size: 0.75rem;
    color: var(--text-muted);
    white-space: nowrap;
}

/* Actions */
.actions-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.action-button {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    padding: 1.5rem 1rem;
    background: rgba(255,255,255,0.05);
    border: 2px solid transparent;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    color: inherit;
}

.action-button:hover {
    background: rgba(0, 188, 212, 0.1);
    border-color: var(--accent);
    transform: translateY(-2px);
}

.action-button .action-icon {
    font-size: 2rem;
}

.action-button .action-text {
    font-weight: 600;
    color: #fff;
    font-size: 0.9rem;
}

/* Responsive */
@media (max-width: 1200px) {
    .dashboard-grid {
        grid-template-columns: 1fr;
    }

    .week-grid {
        grid-template-columns: 1fr;
    }

    .week-divider {
        transform: rotate(90deg);
    }
}

@media (max-width: 768px) {
    .dashboard-header {
        flex-direction: column;
        align-items: flex-start;
    }

    .quick-stats-grid,
    .actions-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
$(document).ready(function() {
    // Load dashboard data
    loadDashboardData();

    // Import button (from old dashboard)
    $('#importAnalyzeBtn').on('click', function() {
        startImportAndAnalyze();
    });
});

function loadDashboardData() {
    $.ajax({
        url: '/api/dashboard-stats',
        method: 'GET',
        success: function(data) {
            console.log('Dashboard data:', data);
            if (data.success) {
                updateDashboard(data);
            }
        },
        error: function(xhr, status, error) {
            console.error('Error loading dashboard:', error);
        }
    });
}

function updateDashboard(data) {
    const patternNames = {
        'fork': 'Gabel',
        'pin': 'Fesselung',
        'skewer': 'Spie√ü',
        'mate': 'Matt',
        'mateIn1': 'Matt in 1',
        'mateIn2': 'Matt in 2',
        'hangingPiece': 'H√§ngende Figur',
        'discoveredAttack': 'Abzugsangriff',
        'backRankMate': 'Grundreihenmatt'
    };

    // === STREAK ===
    $('#streakNumber').text(data.streak_days);

    // === WEEK COMPARISON ===
    $('#currentWeekPuzzles').text(data.current_week.puzzles_solved);
    $('#currentWeekSuccess').text(data.current_week.success_rate + '%');
    $('#currentWeekTime').text(formatTime(data.current_week.avg_time));

    $('#lastWeekPuzzles').text(data.last_week.puzzles_solved);
    $('#lastWeekSuccess').text(data.last_week.success_rate + '%');
    $('#lastWeekTime').text(formatTime(data.last_week.avg_time));

    // Calculate changes
    const puzzlesDiff = data.current_week.puzzles_solved - data.last_week.puzzles_solved;
    const successDiff = data.current_week.success_rate - data.last_week.success_rate;
    const timeDiff = data.last_week.avg_time - data.current_week.avg_time; // Positive = faster

    updateChangeBadge('#puzzlesChange', puzzlesDiff, 'count');
    updateChangeBadge('#successChange', successDiff, 'percent');
    updateChangeBadge('#timeChange', timeDiff, 'time');

    // === WEAKNESSES ===
    const weaknessesHtml = data.weaknesses.map(w => `
        <div class="weakness-item">
            <div class="weakness-info">
                <div class="weakness-name">${patternNames[w.pattern] || w.pattern}</div>
                <div class="weakness-rate">${w.solved}/${w.total} gel√∂st</div>
            </div>
            <div class="weakness-badge">${w.success_rate}%</div>
            <a href="/training?pattern=${w.pattern}" class="train-btn">Trainieren</a>
        </div>
    `).join('');

    $('#weaknessesList').html(weaknessesHtml || '<div class="text-center text-muted py-3">Noch keine Daten</div>');

    // === QUICK STATS ===
    $('#totalSolved').text(data.overall.total_solved);
    $('#successRate').text(data.overall.success_rate + '%');
    $('#totalGames').text(data.overall.total_games);
    $('#totalErrors').text(data.overall.total_errors);

    // === ACHIEVEMENTS ===
    const achievementsHtml = data.achievements.map(a => `
        <div class="achievement-item">
            <div class="achievement-header">
                <span class="achievement-title">${a.title}</span>
                <span class="achievement-progress">${a.current}/${a.target}</span>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar-fill" style="width: ${a.progress}%"></div>
            </div>
        </div>
    `).join('');

    $('#achievementsList').html(achievementsHtml);

    // === RECENT ACTIVITY ===
    const activityHtml = data.recent_activity.map(a => {
        const icon = a.solved ? '‚úÖ' : '‚ùå';
        const pattern = patternNames[a.pattern] || a.pattern;
        const retry = a.is_retry ? 'üîÅ ' : '';

        return `
            <div class="activity-item">
                <div class="activity-icon">${icon}</div>
                <div class="activity-info">
                    <div class="activity-text">${retry}${pattern} (${a.rating || '?'})</div>
                    <div class="activity-meta">${a.solved ? 'Gel√∂st' : 'Gescheitert'}</div>
                </div>
                <div class="activity-time">${a.time_ago}</div>
            </div>
        `;
    }).join('');

    $('#recentActivityList').html(activityHtml || '<div class="text-center text-muted py-3">Noch keine Aktivit√§t</div>');
}

function updateChangeBadge(selector, diff, type) {
    const badge = $(selector);
    let text = '';
    let className = 'neutral';

    if (type === 'count' || type === 'percent') {
        if (diff > 0) {
            text = '+' + diff + (type === 'percent' ? '%' : '');
            className = 'positive';
        } else if (diff < 0) {
            text = diff + (type === 'percent' ? '%' : '');
            className = 'negative';
        } else {
            text = '¬±0' + (type === 'percent' ? '%' : '');
        }
    } else if (type === 'time') {
        if (diff > 0) {
            text = '-' + diff + 's'; // Faster (time decreased)
            className = 'positive';
        } else if (diff < 0) {
            text = '+' + Math.abs(diff) + 's'; // Slower
            className = 'negative';
        } else {
            text = '¬±0s';
        }
    }

    badge.text(text).removeClass('positive negative neutral').addClass(className);
}

function formatTime(seconds) {
    if (!seconds || seconds === 0) return '-';
    if (seconds >= 60) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}m ${secs}s`;
    }
    return seconds + 's';
}

// Import & Analyze (from old dashboard)
function startImportAndAnalyze() {
    $('#importAnalyzeBtn').prop('disabled', true).text('Starte...');
    $('#analysisProgress').show();

    $.ajax({
        url: '/api/import-and-analyze',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({}),
        success: function(response) {
            pollAnalysisProgress();
        },
        error: function(xhr, status, error) {
            console.error('Error starting analysis:', error);
            $('#importAnalyzeBtn').prop('disabled', false).text('Analyse starten');
            alert('Fehler beim Starten der Analyse');
        }
    });
}

function pollAnalysisProgress() {
    const interval = setInterval(function() {
        $.ajax({
            url: '/api/analysis-progress',
            method: 'GET',
            success: function(data) {
                const percentage = data.progress || 0;
                const status = data.status || 'running';

                $('#progressBar').css('width', percentage + '%');
                $('#progressText').text(percentage + '%');
                $('#progressDetails').text(data.message || 'Analysiere Spiele...');

                if (status === 'completed' || status === 'failed') {
                    clearInterval(interval);
                    $('#importAnalyzeBtn').prop('disabled', false).text('Analyse starten');

                    if (status === 'completed') {
                        setTimeout(function() {
                            location.reload();
                        }, 2000);
                    }
                }
            }
        });
    }, 1000);
}
</script>
{% endblock %}
