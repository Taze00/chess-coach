{% extends "base.html" %}

{% block title %}Analyse - Chess Coach{% endblock %}

{% block content %}
<div class="analyse-page">
    <!-- Header mit Import -->
    <div class="analyse-header">
        <div>
            <h1>ðŸ“Š Analyse & Import</h1>
            <p class="text-muted">Importiere Partien und trainiere deine SchwÃ¤chen</p>
        </div>
    </div>

    <!-- Import Section (immer sichtbar) -->
    <div class="import-section">
        <div class="import-card">
            <div class="import-icon">ðŸ“¥</div>
            <div class="import-content">
                <h3>Spiele importieren</h3>
                <p>Importiere deine Chess.com Partien um neue Fehler zu analysieren</p>
                <form method="POST" action="{{ url_for('analyse') }}" class="import-form">
                    <input type="text" name="username" placeholder="Chess.com Username" required class="username-input">
                    <button type="submit" class="btn-import">Importieren</button>
                </form>
            </div>
        </div>
    </div>

    {% if errors %}
    {% set pattern_errors = {} %}
    {% for error in errors %}
        {% set pattern = error.get_primary_pattern() %}
        {% if pattern %}
            {% if pattern not in pattern_errors %}
                {% set _ = pattern_errors.update({pattern: []}) %}
            {% endif %}
            {% set _ = pattern_errors[pattern].append(error) %}
        {% endif %}
    {% endfor %}

    <!-- Fehlerverteilung -->
    <div class="error-distribution">
        <h3 class="section-title">ðŸ“Š Deine Fehlerverteilung</h3>
        <div class="distribution-card">
            <div class="distribution-summary">
                <div class="summary-item">
                    <div class="summary-value">{{ errors|length }}</div>
                    <div class="summary-label">Fehler gesamt</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value">{{ pattern_errors|length }}</div>
                    <div class="summary-label">Muster erkannt</div>
                </div>
            </div>

            <div class="pattern-bars">
                {% set sorted_patterns = [] %}
                {% for pattern, error_list in pattern_errors.items() %}
                    {% set _ = sorted_patterns.append((pattern, error_list, error_list|length)) %}
                {% endfor %}

                {% set total_errors = errors|length %}
                {% set display_count = [0] %}
                {% for pattern, pattern_error_list, count in sorted_patterns|sort(attribute='2', reverse=True) %}
                    {% if display_count[0] < 8 %}
                        {% set _ = display_count.append(display_count.pop() + 1) %}
                        {% set percentage = (count / total_errors * 100)|round(1) %}
                        <div class="pattern-bar-item">
                            <div class="pattern-bar-header">
                                <span class="pattern-bar-name">{{ pattern_translations.get(pattern, pattern) }}</span>
                                <span class="pattern-bar-value">{{ count }} ({{ percentage }}%)</span>
                            </div>
                            <div class="pattern-bar-container">
                                <div class="pattern-bar-fill" style="width: {{ percentage }}%"></div>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>

    {% else %}
    <!-- Empty State -->
    <div class="empty-state">
        <div class="empty-icon">ðŸŽ®</div>
        <h3>Noch keine Fehler analysiert</h3>
        <p>Nutze das Formular oben um deine ersten Partien zu importieren!</p>
    </div>
    {% endif %}
</div>

<style>
.analyse-page {
    max-width: 1000px;
    margin: 0 auto;
    padding: 2rem;
}

/* Header */
.analyse-header {
    margin-bottom: 2rem;
}

.analyse-header h1 {
    color: #fff;
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.text-muted {
    color: var(--text-muted);
    font-size: 1rem;
}

/* Import Section */
.import-section {
    margin-bottom: 3rem;
}

.import-card {
    background: linear-gradient(135deg, var(--card-bg) 0%, rgba(52, 152, 219, 0.15) 100%);
    border-radius: 20px;
    padding: 2.5rem;
    display: flex;
    align-items: center;
    gap: 2rem;
    box-shadow: 0 8px 24px rgba(0,0,0,0.3);
}

.import-icon {
    font-size: 4rem;
}

.import-content {
    flex: 1;
}

.import-content h3 {
    color: #fff;
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
}

.import-content p {
    color: var(--text-muted);
    margin-bottom: 1.5rem;
}

.import-form {
    display: flex;
    gap: 1rem;
}

.username-input {
    flex: 1;
    padding: 1rem 1.5rem;
    background: rgba(255,255,255,0.1);
    border: 2px solid rgba(255,255,255,0.2);
    border-radius: 12px;
    color: #fff;
    font-size: 1rem;
    transition: all 0.3s ease;
}

.username-input:focus {
    outline: none;
    border-color: #3498db;
    background: rgba(255,255,255,0.15);
}

.username-input::placeholder {
    color: rgba(255,255,255,0.5);
}

.btn-import {
    padding: 1rem 2.5rem;
    background: #3498db;
    color: #fff;
    border: none;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 16px rgba(52, 152, 219, 0.4);
}

.btn-import:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(52, 152, 219, 0.6);
}

/* Error Distribution */
.error-distribution {
    margin-bottom: 3rem;
}

.section-title {
    color: #fff;
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
}

.distribution-card {
    background: var(--card-bg);
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.distribution-summary {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 2rem;
    padding-bottom: 2rem;
    margin-bottom: 2rem;
    border-bottom: 2px solid rgba(255,255,255,0.1);
}

.summary-item {
    text-align: center;
}

.summary-value {
    font-size: 3rem;
    font-weight: bold;
    color: #3498db;
    line-height: 1;
    margin-bottom: 0.5rem;
}

.summary-label {
    color: var(--text-muted);
    font-size: 1rem;
    font-weight: 500;
}

.pattern-bars {
    /* Container fÃ¼r die Balken */
}

.pattern-bar-item {
    margin-bottom: 2rem;
}

.pattern-bar-item:last-child {
    margin-bottom: 0;
}

.pattern-bar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.pattern-bar-name {
    font-size: 1.1rem;
    font-weight: 600;
    color: #fff;
}

.pattern-bar-value {
    font-size: 0.95rem;
    color: var(--text-muted);
    font-weight: 600;
}

.pattern-bar-container {
    height: 12px;
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
    overflow: hidden;
}

.pattern-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #3498db, #5dade2);
    border-radius: 10px;
    transition: width 0.6s ease;
    animation: fillBar 0.8s ease-out;
}

@keyframes fillBar {
    from {
        width: 0 !important;
    }
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    background: var(--card-bg);
    border-radius: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.empty-icon {
    font-size: 5rem;
    margin-bottom: 1rem;
}

.empty-state h3 {
    color: #fff;
    margin-bottom: 1rem;
}

.empty-state p {
    color: var(--text-muted);
    max-width: 500px;
    margin: 0 auto;
}

/* Responsive */
@media (max-width: 768px) {
    .analyse-page {
        padding: 1rem;
    }

    .import-card {
        flex-direction: column;
        text-align: center;
        padding: 2rem;
    }

    .import-form {
        flex-direction: column;
    }

    .distribution-summary {
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }

    .distribution-card {
        padding: 1.5rem;
    }

    .pattern-bar-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.25rem;
        margin-bottom: 0.75rem;
    }
}
</style>
{% endblock %}
